# define the build steps
steps:
  # install the app dependencies
  - name: 'gcr.io/cloud-builders/npm'
    args: ['install']

#  - name: 'gcr.io/cloud-builders/npm'
#    args: ['run', 'create-env']
#    env:
#    - 'DB_CONNECT=${_SECRET_KEY}'
  # execute the tests
#  - name: 'gcr.io/cloud-builders/npm'
#    args: ['run', 'test'] 

  # build an artifact using the docker builder
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/exploring-gcp-373314/github_devashish-s_cartwire-bin:latest', '.']

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/exploring-gcp-373314/github_devashish-s_cartwire-bin']

# deploy container image to GKE
  - name: 'gcr.io/cloud-builders/gke-deploy'
    args:
    - run
    - --filename=kubernetes.yaml
    - --image=gcr.io/exploring-gcp-373314/github_devashish-s_cartwire-bin
    - --location=us-central1-a
    - --cluster=nginx-1-cluster
  
images:
  - 'gcr.io/exploring-gcp-373314/github_devashish-s_cartwire-bin:latest'